{% extends 'dashboard/students/base.html' %}{% block title %}Dashboard{% endblock %}
{% load crispy_forms_tags %}
{% load custom_filters %}
	{% block content %}
	<main id="main" class="main">
		<section class="section dashboard">
			<div class="row">
				<div class="col-lg-7">
					<div class="row">
						<div class="col-xxl-4 col-md-6">
							<div class="card info-card units-card">
								<div class="card-body">
									<h5 class="card-title">Units <span>| This Semester</span></h5>
									<div class="d-flex align-items-center">
										<div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
											<i class="bi-mortarboard-fill"></i>
										</div>
										<div class="ps-3">
											<h6>{{ TotalUnits|default:"0" }}</h6>	
										</div>
									</div>
								</div>
							</div>
						</div>
			
						<div class="col-xxl-4 col-md-6">
							<div class="card info-card lectures-card">				
								<div class="card-body">
									<h5 class="card-title">Lectures <span>| Today</span></h5>
									<div class="d-flex align-items-center">
										<div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
											<i class="bi-laptop-fill"></i>
										</div>
										<div class="ps-3">
											<h6>{{ TotalLectures|default:0 }}</h6>
										</div>
									</div>
								</div>
				
							</div>
						</div>
						
						<div class="col-12">
							<div class="card">
								<div class="card-body">
									<h5 class="card-title">Modified Meeting Requests</h5>
									<div class="table-responsive">
										<table class="table table-bordered table-striped">
											<thead>
												<tr class="table-active">
													<th>Lecturer</th>
													<th>Title</th>
													<th>Proposed Time</th>
													<th>Proposed Location</th>
													<th>Actions</th>
												</tr>
											</thead>
											<tbody>
												{% for request in modified_requests %}
												<tr>
													<td>{{ request.lecturer.staff.first_name }} {{ request.lecturer.staff.last_name }}</td>
													<td>{{ request.title }}</td>
													<td>{{ request.start_time|date:"D d-M-Y H:i" }} - {{ request.end_time|date:"H:i" }}</td>
													<td>{{ request.location }}</td>
													<td>
														<a href="{% url 'accept_meeting_request' request.id %}" class="btn btn-success btn-sm">Accept</a>
														<a href="{% url 'reject_modified_meeting_request' request.id %}" class="btn btn-danger btn-sm">Reject</a>
													</td>
												</tr>
												{% empty %}
												<tr>
													<td colspan="5" class="text-center">No modified meeting requests.</td>
												</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						
						<div class="col-12">
							<div class="card recent-sales overflow-auto">
								<div class="card-body">
									<h5 class="card-title">Scheduled lectures</h5>
									<div class="table-responsive">
										<table class="table table-bordered table-striped">
											<thead>
												<tr class="table-active">
													<th>#</th>
													<th>Image</th>
													<th>Lecturer</th>
													<th>Unit</th>
													<th>Date</th>
													<th>Time</th>
													<th>Venue</th>
												</tr>
											</thead>
											<tbody>
												{% for lecture in scheduled_lectures %}
												<tr>
													<td>{{ forloop.counter }}</td>
													<td>
														<a href="{% url 'lecturer_calendar' lecture.lecturer.id %}">
															<img src="{{ lecture.lecturer.staff.profile_pic.url }}" class="rounded-circle" height="50px" width="50px" alt="lecturer-dp">
														</a>
													</td>
													<td>{{ lecture.lecturer.staff.first_name|title }} {{ lecture.lecturer.staff.last_name|title }}</td>
													<td>{{ lecture.unit_name }}</td>
													<td>{{ lecture.lecture_date|date:"D d-M-Y" }}</td>
													<td>{{ lecture.start_time|date:"H:i" }} - {{ lecture.end_time|date:"H:i" }} HRS</td>
													<td>
														{% if lecture.is_attending is False %}
														<a href="{% url 'confirm_attendance' lecture.id request.user.student.id %}">
															<span class="badge bg-danger"><i class="bi-exclamation-triangle-fill"></i> Click me</span>
														</a>
														{% elif lecture.lecture_hall is None %}
														<span class="badge bg-primary">Allocation pending</span>
														{% else %}
															{% if lecture.is_taught is False %}
																<span class="badge bg-success">{{ lecture.lecture_hall|default:" -- " }}</span>
															{% else %}
																<a href="{% url 'student_feedback' lecture.lecture_hall.id %}">{{ lecture.lecture_hall|default:" -- " }}</a>
															{% endif %}
														{% endif %}
													</td>
												</tr>
												{% endfor %}
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
						
						<div class="col-12">			
							<div class="card scheduled-lectures-card">
								<div class="card-body">
									<h5 class="card-title">Scheduled lectures <span>| Today</span></h5>
									<div class="activity">
										{% for lecture in scheduled_lectures %}
										<div class="activity-item d-flex">
											{% with lecture.date_scheduled|custom_timesince as time_since %}
											<div class="activity-label">
												{{ time_since }} ago
											</div>
											{% endwith %}
											<a href="{% url 'lecturer_calendar' lecture.lecturer.id %}">
												<img src="{{ lecture.lecturer.staff.profile_pic.url }}" class="rounded-circle activity-badge align-self-start" height="30px" width="30px" alt="user-dp">
											</a>
											<div class="activity-content">
												<p class="small fst-italic">
													{{ lecture.unit_name }} is scheduled to start on <b>{{ lecture.lecture_date|date:"D d-M-Y" }}</b> at <b>{{ lecture.start_time|date:"h:iA" }}</b>
												</p>
											</div>
										</div>
										{% empty %}
										<div class="activity-item">
											<h6 class="small fst-italic text-center">
												There is no scheduled lecture available!
											</h6>
										</div>
										{% endfor %}
										<hr class="dropdown-divider">
										<div class="text-center">
											<a href="{% url 'student_lecture_records' request.user.student %}" class="badge bg-primary p-2">View more</a>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
		
				<div class="col-lg-5">
					<div class="card">
						<div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Calendar</h5>
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                                    <i class="bi bi-plus-circle"></i> Add Event
                                </button>
                            </div>
							<div id="calendar"></div>
						</div>
					</div>

					<div class="card">
						<div class="card-body">
							<h5 class="card-title">Recommendations</h5>
							<div class="activity recommendation-box-content">
								<div class="activity-item d-flex">
									<div class="activity-content">
										<p class="small fst-italic">
											<strong>Campus Job Fair</strong><br>
											Date: December 10, 2025<br>
											Description: Meet with representatives from top companies to find internship and full-time opportunities.
										</p>
									</div>
								</div>
								<div class="activity-item d-flex">
									<div class="activity-content">
										<p class="small fst-italic">
											<strong>Christmas Celebration Party</strong><br>
											Date: December 24, 2025<br>
											Description: Celebrate Christmas with friends, enjoy delicious food, and watch wonderful performances.
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

        <!-- Add Event Modal -->
        <div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addEventModalLabel">Add Personal Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addEventForm">
                            {% csrf_token %}
                            {{ personal_event_form|crispy }}
                            <div id="add-form-errors" class="text-danger mt-2"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveEventBtn">Save Event</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Event Modal -->
        <div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true" 
             data-update-url-template="{% url 'update_personal_event' '0' %}" 
             data-delete-url-template="{% url 'delete_personal_event' '0' %}">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editEventModalLabel">Edit Personal Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEventForm">
                            {% csrf_token %}
                            <input type="hidden" id="edit_event_id" name="event_id">
                            {{ personal_event_form|crispy }}
                            <div id="edit-form-errors" class="text-danger mt-2"></div>
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete</button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="updateEventBtn">Update Event</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		
		<script>
            // Helper to format dates for datetime-local input
            function toLocalISOString(date) {
                const d = new Date(date);
                const pad = (num) => (num < 10 ? '0' + num : num);
                return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

			document.addEventListener('DOMContentLoaded', function() {
				var calendarEl = document.getElementById('calendar');
                var lectureEvents = {{ events|safe }};
                var addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
                var editEventModalEl = document.getElementById('editEventModal');
                var editEventModal = new bootstrap.Modal(editEventModalEl);
                var addEventForm = document.getElementById('addEventForm');
                var editEventForm = document.getElementById('editEventForm');

				var calendar = new FullCalendar.Calendar(calendarEl, {
					initialView: 'dayGridMonth',
                    height: 'auto',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    selectable: true,
                    eventSources: [
                        {
                            events: lectureEvents
                        },
                        {
                            url: "{% url 'get_personal_events' %}",
                            failure: function() {
                                alert('There was an error while fetching personal events!');
                            }
                        }
                    ],
                    eventClick: function(info) {
                        // Check if it's a personal event by looking for a property personal events have
                        if (info.event.extendedProps.description !== undefined) {
                            document.getElementById('edit_event_id').value = info.event.id;
                            editEventForm.querySelector('#id_title').value = info.event.title;
                            editEventForm.querySelector('#id_description').value = info.event.extendedProps.description || '';
                            editEventForm.querySelector('#id_start_date').value = toLocalISOString(info.event.start);
                            editEventForm.querySelector('#id_end_date').value = info.event.end ? toLocalISOString(info.event.end) : toLocalISOString(info.event.start);
                            
                            editEventModal.show();
                        }
                    },
                    dateClick: function(info) {
                        // Prefill the start date of the new event form with the clicked date
                        addEventForm.reset(); // Reset form before showing
                        document.getElementById('add-form-errors').innerText = ''; // Clear previous errors
                        addEventForm.querySelector('#id_start_date').value = toLocalISOString(info.date);
                        addEventModal.show();
                    }
				});
				calendar.render();

                // Handle ADD form submission
                document.getElementById('saveEventBtn').addEventListener('click', function() {
                    var formData = new FormData(addEventForm);
                    
                    fetch("{% url 'add_personal_event' %}", {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            addEventModal.hide();
                            addEventForm.reset();
                            calendar.refetchEvents();
                        } else {
                            document.getElementById('add-form-errors').innerText = 'Please correct the errors below.';
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });

                // Handle UPDATE form submission
                document.getElementById('updateEventBtn').addEventListener('click', function() {
                    var eventId = document.getElementById('edit_event_id').value;
                    var formData = new FormData(editEventForm);
                    var urlTemplate = editEventModalEl.dataset.updateUrlTemplate;
                    var url = urlTemplate.replace('0', eventId);

                    fetch(url, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            editEventModal.hide();
                            calendar.refetchEvents();
                        } else {
                            document.getElementById('edit-form-errors').innerText = 'Please correct the errors below.';
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });

                // Handle DELETE button click
                document.getElementById('deleteEventBtn').addEventListener('click', function() {
                    var eventId = document.getElementById('edit_event_id').value;
                    var urlTemplate = editEventModalEl.dataset.deleteUrlTemplate;
                    var url = urlTemplate.replace('0', eventId);

                    if (confirm('Are you sure you want to delete this event?')) {
                        fetch(url, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                editEventModal.hide();
                                calendar.refetchEvents();
                            } else {
                                alert('Error deleting event: ' + data.message);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                });
			});
		</script>
	</main>
	{% endblock %}